name: Pull Request Build

on:
  workflow_dispatch:
  pull_request:
    branches: 
    - "main"
    - "dev/hammar/*"
    paths: 
    - '.github/**'
    - 'SmartPlaces.Facilities/**'

env: 
  BUILD_CONFIGURATION: 'Release'    # set this to the appropriate build configuration
  DOTNET_VERSION: '6.x' 

jobs:
  build-docs:
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x
    - name: Generate documentation
      uses: FuLagann/csharp-docs-generator@v1.0
      with:
        build-tasks: dotnet build ./SmartPlaces.Facilities/lib/OntologyMapper/,dotnet build ./SmartPlaces.Facilities/lib/OntologyMapper.Mapped/,dotnet build ./SmartPlaces.Facilities/lib/IngestionManager/,dotnet build ./SmartPlaces.Facilities/lib/IngestionManager.Mapped/,dotnet build ./SmartPlaces.Facilities/samples/Topology/
        cleanup-tasks: dotnet clean ./SmartPlaces.Facilities/lib/OntologyMapper/,dotnet clean ./SmartPlaces.Facilities/lib/OntologyMapper.Mapped/,dotnet clean ./SmartPlaces.Facilities/lib/IngestionManager/,dotnet clean ./SmartPlaces.Facilities/lib/IngestionManager.Mapped/,dotnet clean ./SmartPlaces.Facilities/samples/Topology/
        binaries: SmartPlaces.Facilities/lib/IngestionManager/src/bin/Debug/net6.0/Microsoft.SmartPlaces.Facilities.IngestionManager.dll,SmartPlaces.Facilities/lib/IngestionManager.Mapped/src/bin/Debug/net6.0/Microsoft.SmartPlaces.Facilities.IngestionManager.Mapped.dll,SmartPlaces.Facilities/lib/OntologyMapper/src/bin/Debug/net6.0/Microsoft.SmartPlaces.Facilities.OntologyMapper.dll,SmartPlaces.Facilities/lib/OntologyMapper.Mapped/src/bin/Debug/net6.0/Microsoft.SmartPlaces.Facilities.OntologyMapper.Mapped.dll,SmartPlaces.Facilities/samples/Topology/src/bin/Debug/net6.0/Topology.dll
        output-path: SmartPlaces.Facilities/docs
        skip-git: true
    - name: Commit and push documentation
      run: |
        git config user.name "Smart Places and Energy Team"
        git config user.email "smartplaces@microsoft.com"
        git add .
        git commit -m "Autogenerated documentation for SmartPlaces.Facilities"
        git push


  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: 6.0.x

    - name: Restore dependencies
      run: |
           dotnet restore SmartPlaces.Facilities\\lib\\OntologyMapper
           dotnet restore SmartPlaces.Facilities\\lib\\OntologyMapper.Mapped
           dotnet restore SmartPlaces.Facilities\\lib\\IngestionManager
           dotnet restore SmartPlaces.Facilities\\lib\\IngestionManager.Mapped
           dotnet restore SmartPlaces.Facilities\\samples\\Topology
    - name: Build
      run: |
           dotnet build SmartPlaces.Facilities\\lib\\OntologyMapper --no-restore
           dotnet build SmartPlaces.Facilities\\lib\\OntologyMapper.Mapped --no-restore
           dotnet build SmartPlaces.Facilities\\lib\\IngestionManager --no-restore
           dotnet build SmartPlaces.Facilities\\lib\\IngestionManager.Mapped --no-restore
           dotnet build SmartPlaces.Facilities\\samples\\Topology --no-restore
    - name: Test
      run: |
           dotnet test SmartPlaces.Facilities\\lib\\OntologyMapper --no-build --verbosity normal
           dotnet test SmartPlaces.Facilities\\lib\\OntologyMapper.Mapped --no-build --verbosity normal
           dotnet test SmartPlaces.Facilities\\lib\\IngestionManager --no-build --verbosity normal
           dotnet test SmartPlaces.Facilities\\lib\\IngestionManager.Mapped --no-build --verbosity normal
           